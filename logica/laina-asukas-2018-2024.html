
<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Laukaainfo.fi 2026 - Semantic Intelligence Fingerprint: Generated by Semantix Alusta -->
    <meta name="copyright" content="Laukaainfo.fi">
    <title>Ontologiavisualisointi: Laukaan kunnan ja kuntakonsernin asukaskohtainen l...</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; background: #f8f9fa; color: #1e293b; overflow-x: hidden; position: relative; min-height: 100vh; }
        #container { width: 100vw; height: 100vh; overflow: auto; position: relative; }
        #graph { width: 100%; height: 100%; }
        #info { 
            position: fixed; top: 20px; right: 20px; width: 320px; 
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(8px);
            padding: 24px; border-radius: 20px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.1); display: none;
            max-height: 85vh; overflow-y: auto; z-index: 1000;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        #search-btn {
            position: fixed; top: 20px; right: 150px; z-index: 900;
            background: #ffffff; color: #4f46e5; border: 1px solid #e2e8f0; padding: 10px 20px;
            border-radius: 12px; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            transition: all 0.2s;
        }
        #search-btn:hover { background: #f8fafc; }
        #search-panel {
            position: fixed; top: 70px; right: 150px; width: 320px;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(8px);
            padding: 24px; border-radius: 20px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.1); display: none;
            max-height: 85vh; overflow-y: auto; z-index: 1000;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        select.fs-select { width: 100%; padding: 8px; margin-bottom: 12px; border-radius: 8px; border: 1px solid #e2e8f0; font-size: 12px; background: #f8fafc; outline: none; }
        .fs-btn { background: #6366f1; color: white; border: none; padding: 8px 16px; border-radius: 8px; font-size: 12px; font-weight: bold; cursor: pointer; width: 100%; margin-bottom: 8px; }
        .fs-btn:disabled { background: #cbd5e1; cursor: not-allowed; }
        .fs-btn-clear { background: #f1f5f9; color: #475569; border: none; padding: 8px 16px; border-radius: 8px; font-size: 12px; font-weight: bold; cursor: pointer; width: 100%; }
        .path-result { margin-top: 16px; padding-top: 16px; border-top: 1px solid #e2e8f0; }
        #summary-btn {
            position: fixed; top: 20px; right: 20px; z-index: 900;
            background: #6366f1; color: white; border: none; padding: 10px 20px;
            border-radius: 12px; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
            transition: all 0.2s;
        }
        #summary-btn:hover { background: #4f46e5; transform: translateY(-1px); }
        #summary-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.5); backdrop-filter: blur(4px);
            display: none; z-index: 2000; align-items: center; justify-content: center;
            padding: 20px;
        }
        .modal-content {
            background: white; padding: 32px; border-radius: 24px; max-width: 600px;
            width: 100%; max-height: 80vh; overflow-y: auto; position: relative;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
        }
        @media (max-width: 640px) {
            #info {
                top: auto; right: 0; bottom: 0; left: 0;
                width: auto; border-radius: 24px 24px 0 0;
                max-height: 60vh;
            }
            #summary-btn { top: 10px; right: 10px; padding: 8px 16px; font-size: 13px; }
            #search-btn { top: 10px; right: 120px; padding: 8px 16px; font-size: 13px; }
            #search-panel { 
                top: auto; right: 0; bottom: 0; left: 0; 
                width: auto; border-radius: 24px 24px 0 0; 
                max-height: 60vh; 
            }
        }
        .node { cursor: pointer; stroke: #fff; stroke-width: 2px; }
        .link { stroke: #cbd5e1; stroke-opacity: 0.5; stroke-width: 1.5px; }
        .link-label { font-size: 9px; fill: #64748b; text-anchor: middle; pointer-events: none; }
        .label { font-size: 12px; pointer-events: none; font-weight: 600; fill: #1e293b; }
        h3 { margin-top: 0; color: #1e293b; font-size: 1.25rem; font-weight: 800; }
        .type-tag { 
            display: inline-block; padding: 4px 10px; border-radius: 8px; 
            font-size: 10px; font-weight: 800; background: #f1f5f9; color: #475569;
            margin-bottom: 16px; text-transform: uppercase; letter-spacing: 0.05em;
        }
        .close-btn { position: absolute; top: 16px; right: 16px; cursor: pointer; border: none; background: #f1f5f9; width: 32px; height: 32px; border-radius: 50%; font-size: 18px; display: flex; align-items: center; justify-content: center; }
        
        .timeline-container { max-width: 800px; margin: 60px auto; padding: 20px; position: relative; }
        .timeline-line { position: absolute; left: 40px; top: 0; bottom: 0; width: 2px; background: #e2e8f0; }
        .timeline-item { position: relative; margin-bottom: 48px; padding-left: 80px; }
        .timeline-dot { 
            position: absolute; left: 20px; top: 0; width: 40px; height: 40px; 
            background: white; border: 4px solid #6366f1; border-radius: 50%; 
            cursor: pointer; z-index: 10; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
        }
        .timeline-card { 
            background: white; padding: 24px; border-radius: 20px; 
            border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
            cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
        }
        .timeline-card:hover { transform: translateX(4px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .timeline-change {
            margin: 12px 0 12px 40px; padding: 6px 16px; background: #f5f3ff;
            color: #4f46e5; border-radius: 20px; font-size: 11px; font-weight: 800;
            display: inline-block; border: 1px solid #ddd6fe;
        }
        footer {
            position: absolute; bottom: 20px; left: 0; width: 100%; text-align: center;
            font-size: 11px; color: #94a3b8; opacity: 0.8;
            display: flex; flex-direction: column; align-items: center; gap: 8px;
            pointer-events: auto;
        }
        .disclaimer {
            font-size: 9px; color: #cbd5e1; max-width: 400px; line-height: 1.4;
            margin-top: 4px;
        }
        .branding-link {
            color: #6366f1; text-decoration: none; font-weight: 800;
            transition: color 0.2s;
        }
        .branding-link:hover { color: #4f46e5; }
    </style>
</head>
<body>
    <div id="container">
        <button id="summary-btn" onclick="document.getElementById('summary-modal').style.display='flex'">Yhteenveto</button>
        <button id="search-btn" onclick="toggleSearchPanel()">Yhteyshaku</button>
        
        <div id="search-panel">
            <button class="close-btn" onclick="document.getElementById('search-panel').style.display='none'">&times;</button>
            <h3 style="color: #1e293b; margin-bottom: 16px; font-size: 16px;">Etsi yhteys</h3>
            
            <label style="font-size: 10px; font-weight: 800; color: #64748b; text-transform: uppercase;">Mistä (Solmu A)</label>
            <select id="search-a" class="fs-select" onchange="updateSearchUI()"><option value="">-- Valitse solmu --</option></select>
            
            <label style="font-size: 10px; font-weight: 800; color: #64748b; text-transform: uppercase;">Mihin (Solmu B)</label>
            <select id="search-b" class="fs-select" onchange="updateSearchUI()"><option value="">-- Valitse solmu --</option></select>
            
            <div style="display: flex; gap: 8px;">
                <button id="do-search-btn" class="fs-btn" onclick="executeSearch()" disabled>Hae reitti</button>
                <button class="fs-btn-clear" onclick="clearSearch()">Tyhjennä</button>
            </div>
            
            <div id="search-results" class="path-result" style="display: none;"></div>
        </div>
        
        <div id="summary-modal" onclick="if(event.target === this) this.style.display='none'">
            <div class="modal-content">
                <button class="close-btn" onclick="document.getElementById('summary-modal').style.display='none'">&times;</button>
                <h3 style="color: #6366f1; margin-bottom: 16px;">Analyysin yhteenveto</h3>
                <p id="sum-p" style="font-size: 16px; color: #334155; line-height: 1.8; font-style: italic;"></p>
            </div>
        </div>

        
            <div class="timeline-container">
                <div class="timeline-line"></div>
                <div id="timeline-content"></div>
            </div>
        
    </div>
    
    <div id="info">
        <button class="close-btn" onclick="document.getElementById('info').style.display='none'">&times;</button>
        <h3 id="info-title"></h3>
        <div id="info-type" class="type-tag"></div>
        <p id="info-desc" style="font-size: 14px; color: #475569; line-height: 1.6; margin-bottom: 20px;"></p>
        <div id="info-sources-title" style="font-size: 11px; font-weight: 800; color: #94a3b8; text-transform: uppercase; margin-bottom: 8px; display: none;">Lähteet</div>
        <div id="info-source" style="display: flex; flex-direction: column; gap: 8px;"></div>
    </div>

    <footer>
        <div style="font-weight: 800;">Laukaainfo.fi 2026</div>
        <div class="disclaimer">
            Analyysi perustuu tekoälyyn, joten varmista aina tiedot alkuperäisistä lähteistä. 
            Tämä sivu on generoitu Semantix-alustalla.
        </div>
        <div style="font-size: 8px; color: #e2e8f0; margin-top: 10px;" data-copyright="Laukaainfo.fi" data-fingerprint="r8ma8pk0rg">© Laukaainfo.fi - Semantic Intelligence Fingerprint Embedded</div>
    </footer>

    <script>
        (function() {
            const _LFI_MARK = "Laukaainfo.fi - Tekijänoikeus suojattu";
            const _enc = {
                d: ["eyJzdW1tYXJ5IjoiTGF1a2FhbiBrdW5uYW4gamEga3VudGFrb2","5zZXJuaW4gYXN1a2Fza29odGFpbmVuIGxhaW5hbcOkw6Ryw6Qg","b24ga2FzdmFudXQgbWVya2l0dMOkdsOkc3RpIHRhcmthc3RlbH","VqYWtzb2xsYSAyMDE44oCTMjAyNCwgc2FhdnV0dGFlbiBodWlw","cHVuc2Ega3VubmFuIG9zYWx0YSB2dW9ubmEgMjAyMyBqYSBrb2","5zZXJuaW4gb3NhbHRhIHZ1b25uYSAyMDIyLiBLb25zZXJuaWxh","aW5ha2FudGEgc2lzw6RsdMOkw6Qga3VubmFuIG9taWVuIGxhaW","5vamVuIGxpc8Oka3NpIHR5dMOkcnlodGVpc8O2amVuLCBrdXRl","biB2ZXNpaHVvbGxvbiBqYSB2dW9rcmFrb3RpZW4sIHNla8OkIG","FpZW1taW4gbXnDtnMgc2FpcmFhbmhvaXRvcGlpcmluIGxhaW5h","dC4iLCJub2RlcyI6W3siaWQiOiJrdW50YV9sYWluYV8yMDE4Ii","widHlwZSI6Im1pdHRhcmkiLCJsYWJlbCI6Ikt1bm5hbiBsYWlu","YXQgMjAxOCIsInNvdXJjZSI6IlRpbGlucGFhdG9zLTIwMTgucG","RmIiwiZGVzY3JpcHRpb24iOiJLdW5uYW4gbGFpbmF0IGFzdWth","c3RhIGtvaGRlbiB2dW9ubmEgMjAxOCBvbGl2YXQgNCA2NTQg4o","KsLiIsImRhdGUiOiIyMDE4Iiwib3JkZXIiOjF9LHsiaWQiOiJr","b25zZXJuaV9sYWluYV8yMDE4IiwidHlwZSI6Im1pdHRhcmkiLC","JsYWJlbCI6Ikt1bnRha29uc2VybmluIGxhaW5hdCAyMDE4Iiwi","c291cmNlIjoiVGlsaW5wYWF0b3MtMjAxOC5wZGYiLCJkZXNjcm","lwdGlvbiI6Ikt1bnRha29uc2VybmluIGxhaW5hdCBhc3VrYXN0","YSBrb2hkZW4gdnVvbm5hIDIwMTggb2xpdmF0IDYgNzY5IOKCrC","4iLCJkYXRlIjoiMjAxOCIsIm9yZGVyIjoyfSx7ImlkIjoia3Vu","dGFfbGFpbmFfMjAxOSIsInR5cGUiOiJtaXR0YXJpIiwibGFiZW","wiOiJLdW5uYW4gbGFpbmF0IDIwMTkiLCJzb3VyY2UiOiJUaWxp","bnBhYXRvcy0yMDE5LnBkZiIsImRlc2NyaXB0aW9uIjoiS3Vubm","FuIGxhaW5hdCBhc3VrYXN0YSBrb2hkZW4gdnVvbm5hIDIwMTkg","b2xpdmF0IDUgMTg5IOKCrC4iLCJkYXRlIjoiMjAxOSIsIm9yZG","VyIjozfSx7ImlkIjoia29uc2VybmlfbGFpbmFfMjAxOSIsInR5","cGUiOiJtaXR0YXJpIiwibGFiZWwiOiJLdW50YWtvbnNlcm5pbi","BsYWluYXQgMjAxOSIsInNvdXJjZSI6IlRpbGlucGFhdG9zLTIw","MTkucGRmIiwiZGVzY3JpcHRpb24iOiJLdW50YWtvbnNlcm5pbi","BsYWluYXQgYXN1a2FzdGEga29oZGVuIHZ1b25uYSAyMDE5IG9s","aXZhdCA3IDY1MCDigqwuIiwiZGF0ZSI6IjIwMTkiLCJvcmRlci","I6NH0seyJpZCI6Imt1bnRhX2xhaW5hXzIwMjAiLCJ0eXBlIjoi","bWl0dGFyaSIsImxhYmVsIjoiS3VubmFuIGxhaW5hdCAyMDIwIi","wic291cmNlIjoiVGlsaW5wYWF0b3MtMjAyMC5wZGYiLCJkZXNj","cmlwdGlvbiI6Ikt1bm5hbiBsYWluYXQgYXN1a2FzdGEga29oZG","VuIHZ1b25uYSAyMDIwIG9saXZhdCA0IDk5NCDigqwuIiwiZGF0","ZSI6IjIwMjAiLCJvcmRlciI6NX0seyJpZCI6ImtvbnNlcm5pX2","xhaW5hXzIwMjAiLCJ0eXBlIjoibWl0dGFyaSIsImxhYmVsIjoi","S3VudGFrb25zZXJuaW4gbGFpbmF0IDIwMjAiLCJzb3VyY2UiOi","JUaWxpbnBhYXRvcy0yMDIwLnBkZiIsImRlc2NyaXB0aW9uIjoi","S3VudGFrb25zZXJuaW4gbGFpbmF0IGFzdWthc3RhIGtvaGRlbi","B2dW9ubmEgMjAyMCBvbGl2YXQgNyA4MjIg4oKsLiIsImRhdGUi","OiIyMDIwIiwib3JkZXIiOjZ9LHsiaWQiOiJrdW50YV9sYWluYV","8yMDIxIiwidHlwZSI6Im1pdHRhcmkiLCJsYWJlbCI6Ikt1bm5h","biBsYWluYXQgMjAyMSIsInNvdXJjZSI6IlRQLTIwMjEta2lyam","FfS1YwNjA2MjAyMi5wZGYiLCJkZXNjcmlwdGlvbiI6Ikt1bm5h","biBsYWluYXQgYXN1a2FzdGEga29oZGVuIHZ1b25uYSAyMDIxIG","9saXZhdCA1IDUzNiDigqwuIiwiZGF0ZSI6IjIwMjEiLCJvcmRl","ciI6N30seyJpZCI6ImtvbnNlcm5pX2xhaW5hXzIwMjEiLCJ0eX","BlIjoibWl0dGFyaSIsImxhYmVsIjoiS3VudGFrb25zZXJuaW4g","bGFpbmF0IDIwMjEiLCJzb3VyY2UiOiJUUC0yMDIxLWtpcmphX0","tWMDYwNjIwMjIucGRmIiwiZGVzY3JpcHRpb24iOiJLdW50YWtv","bnNlcm5pbiBsYWluYXQgYXN1a2FzdGEga29oZGVuIHZ1b25uYS","AyMDIxIG9saXZhdCA4IDYxNCDigqwuIiwiZGF0ZSI6IjIwMjEi","LCJvcmRlciI6OH0seyJpZCI6Imt1bnRhX2xhaW5hXzIwMjIiLC","J0eXBlIjoibWl0dGFyaSIsImxhYmVsIjoiS3VubmFuIGxhaW5h","dCAyMDIyIiwic291cmNlIjoidHAtMjAyMi1raXJqYS1rdl92ZX","JzaW8ucGRmIiwiZGVzY3JpcHRpb24iOiJLdW5uYW4gbGFpbmF0","IGFzdWthc3RhIGtvaGRlbiB2dW9ubmEgMjAyMiBvbGl2YXQgNS","A4MDYg4oKsLiIsImRhdGUiOiIyMDIyIiwib3JkZXIiOjl9LHsi","aWQiOiJrb25zZXJuaV9sYWluYV8yMDIyIiwidHlwZSI6Im1pdH","RhcmkiLCJsYWJlbCI6Ikt1bnRha29uc2VybmluIGxhaW5hdCAy","MDIyIiwic291cmNlIjoidHAtMjAyMi1raXJqYS1rdl92ZXJzaW","8ucGRmIiwiZGVzY3JpcHRpb24iOiJLdW50YWtvbnNlcm5pbiBs","YWluYXQgYXN1a2FzdGEga29oZGVuIHZ1b25uYSAyMDIyIG9saX","ZhdCA4IDgzNiDigqwgKGh1aXBwdXZ1b3NpKS4iLCJkYXRlIjoi","MjAyMiIsIm9yZGVyIjoxMH0seyJpZCI6Imt1bnRhX2xhaW5hXz","IwMjMiLCJ0eXBlIjoibWl0dGFyaSIsImxhYmVsIjoiS3VubmFu","IGxhaW5hdCAyMDIzIiwic291cmNlIjoidHAtMjAyMy5wZGYiLC","JkZXNjcmlwdGlvbiI6Ikt1bm5hbiBsYWluYXQgYXN1a2FzdGEg","a29oZGVuIHZ1b25uYSAyMDIzIG9saXZhdCA1IDg5MSDigqwgKG","h1aXBwdXZ1b3NpKS4iLCJkYXRlIjoiMjAyMyIsIm9yZGVyIjox","MX0seyJpZCI6ImtvbnNlcm5pX2xhaW5hXzIwMjMiLCJ0eXBlIj","oibWl0dGFyaSIsImxhYmVsIjoiS3VudGFrb25zZXJuaW4gbGFp","bmF0IDIwMjMiLCJzb3VyY2UiOiJ0cC0yMDIzLnBkZiIsImRlc2","NyaXB0aW9uIjoiS3VudGFrb25zZXJuaW4gbGFpbmF0IGFzdWth","c3RhIGtvaGRlbiB2dW9ubmEgMjAyMyBsYXNraXZhdCA3IDQwOC","BldXJvb24gaHl2aW52b2ludGlhbHVldXVkaXN0dWtzZW4gdnVv","a3NpLiIsImRhdGUiOiIyMDIzIiwib3JkZXIiOjEyfSx7ImlkIj","oia3VudGFfbGFpbmFfMjAyNCIsInR5cGUiOiJtaXR0YXJpIiwi","bGFiZWwiOiJLdW5uYW4gbGFpbmF0IDIwMjQiLCJzb3VyY2UiOi","J0cC0yMDI0LnBkZiIsImRlc2NyaXB0aW9uIjoiS3VubmFuIGxh","aW5hdCBhc3VrYXN0YSBrb2hkZW4gdnVvbm5hIDIwMjQgbGFza2","l2YXQgNSA3ODIgZXVyb29uLiIsImRhdGUiOiIyMDI0Iiwib3Jk","ZXIiOjEzfSx7ImlkIjoia29uc2VybmlfbGFpbmFfMjAyNCIsIn","R5cGUiOiJtaXR0YXJpIiwibGFiZWwiOiJLdW50YWtvbnNlcm5p","biBsYWluYXQgMjAyNCIsInNvdXJjZSI6InRwLTIwMjQucGRmIi","wiZGVzY3JpcHRpb24iOiJLdW50YWtvbnNlcm5pbiBsYWluYXQg","YXN1a2FzdGEga29oZGVuIHZ1b25uYSAyMDI0IGxhc2tpdmF0ID","cgMTQ5IGV1cm9vbi4iLCJkYXRlIjoiMjAyNCIsIm9yZGVyIjox","NH0seyJpZCI6ImludmVzdG9pbm5pdF9rb3VsdXQiLCJ0eXBlIj","oidGFwYWh0dW1hIiwibGFiZWwiOiJLb3VsdWludmVzdG9pbm5p","dCIsInNvdXJjZSI6IlRQLTIwMjEta2lyamFfS1YwNjA2MjAyMi","5wZGYiLCJkZXNjcmlwdGlvbiI6IlN1dXJldCBrb3VsdWludmVz","dG9pbm5pdCAoVmlodGF2dW9yaSwgS2lya29ua3lsw6QsIGx1a2","lva291bHV0dXMpIGthc3ZhdHRpdmF0IGt1bm5hbiBsYWluYW3D","pMOkcsOkw6QuIiwiZGF0ZSI6IjIwMTgtMjAyMyIsIm9yZGVyIj","oxNX0seyJpZCI6InNhaXJhYWxhX25vdmEiLCJ0eXBlIjoidGFw","YWh0dW1hIiwibGFiZWwiOiJTYWlyYWFsYSBOb3ZhIC1oYW5rZS","IsInNvdXJjZSI6IlRQLTIwMjEta2lyamFfS1YwNjA2MjAyMi5w","ZGYiLCJkZXNjcmlwdGlvbiI6Iktlc2tpLVN1b21lbiBzYWlyYW","FuaG9pdG9waWlyaW4gU2FpcmFhbGEgTm92YSAtaGFua2Uga2Fz","dmF0dGkga3VudGFrb25zZXJuaW4gbGFpbmFtw6TDpHLDpMOkIH","Z1b3RlZW4gMjAyMiBhc3RpLiIsImRhdGUiOiIyMDIyIiwib3Jk","ZXIiOjE2fSx7ImlkIjoiaHZhX3V1ZGlzdHVzIiwidHlwZSI6In","RhcGFodHVtYSIsImxhYmVsIjoiSHl2aW52b2ludGlhbHVldXVk","aXN0dXMiLCJzb3VyY2UiOiJ0cC0yMDIzLnBkZiwgdHAtMjAyNC","5wZGYiLCJkZXNjcmlwdGlvbiI6IlZ1b25uYSAyMDIzIHNhaXJh","YW5ob2l0b3BpaXJpIGVpIGVuw6TDpCBrdXVsdSBrdW5uYW4ga2","9uc2VybmlpbiwgZWlrw6Qgc2VuIGxhaW5vamEgZW7DpMOkIHlo","ZGlzdGVsbMOkIGtvbnNlcm5pdGlldG9paGluLiIsImRhdGUiOi","IyMDIzIiwib3JkZXIiOjE3fSx7ImlkIjoidmFlc3Rvbl9rYXN2","dV8yMDI0IiwidHlwZSI6InRhcGFodHVtYSIsImxhYmVsIjoiVs","OkZXN0w7ZuIGthc3Z1IDIwMjQiLCJzb3VyY2UiOiJ0cC0yMDI0","LnBkZiIsImRlc2NyaXB0aW9uIjoiQXN1a2FzbHV2dW4ga8Okw6","RudHltaW5lbiB5bGzDpHR0w6R2w6TDpG4ga2FzdnV1biBqYWtv","aSB2ZWxrYXRhYWthbiB1c2VhbW1hbGxlIGhlbmtpbMO2bGxlLi","IsImRhdGUiOiIyMDI0Iiwib3JkZXIiOjE4fV0sImVkZ2VzIjpb","eyJzb3VyY2UiOiJpbnZlc3RvaW5uaXRfa291bHV0IiwidGFyZ2","V0Ijoia3VudGFfbGFpbmFfMjAyMSIsImxhYmVsIjoia2FzdmF0","dGFhIiwic291cmNlVXJsIjoiVFAtMjAyMS1raXJqYV9LVjA2MD","YyMDIyLnBkZiJ9LHsic291cmNlIjoiaW52ZXN0b2lubml0X2tv","dWx1dCIsInRhcmdldCI6Imt1bnRhX2xhaW5hXzIwMjIiLCJsYW","JlbCI6Imthc3ZhdHRhYSIsInNvdXJjZVVybCI6IlRQLTIwMjEt","a2lyamFfS1YwNjA2MjAyMi5wZGYifSx7InNvdXJjZSI6Imludm","VzdG9pbm5pdF9rb3VsdXQiLCJ0YXJnZXQiOiJrdW50YV9sYWlu","YV8yMDIzIiwibGFiZWwiOiJrYXN2YXR0YWEiLCJzb3VyY2VVcm","wiOiJUUC0yMDIxLWtpcmphX0tWMDYwNjIwMjIucGRmIn0seyJz","b3VyY2UiOiJzYWlyYWFsYV9ub3ZhIiwidGFyZ2V0Ijoia29uc2","VybmlfbGFpbmFfMjAyMiIsImxhYmVsIjoia2FzdmF0dGFhIiwi","c291cmNlVXJsIjoiVFAtMjAyMS1raXJqYV9LVjA2MDYyMDIyLn","BkZiJ9LHsic291cmNlIjoiaHZhX3V1ZGlzdHVzIiwidGFyZ2V0","Ijoia29uc2VybmlfbGFpbmFfMjAyMyIsImxhYmVsIjoidsOkaG","VudMOkw6QiLCJzb3VyY2VVcmwiOiJ0cC0yMDIzLnBkZiJ9LHsi","c291cmNlIjoidmFlc3Rvbl9rYXN2dV8yMDI0IiwidGFyZ2V0Ij","oia3VudGFfbGFpbmFfMjAyNCIsImxhYmVsIjoicGllbmVudMOk","w6QgYXN1a2Fza29odGFpc3RhIGxhaW5hYSIsInNvdXJjZVVybC","I6InRwLTIwMjQucGRmIn0seyJzb3VyY2UiOiJ2YWVzdG9uX2th","c3Z1XzIwMjQiLCJ0YXJnZXQiOiJrb25zZXJuaV9sYWluYV8yMD","I0IiwibGFiZWwiOiJwaWVuZW50w6TDpCBhc3VrYXNrb2h0YWlz","dGEgbGFpbmFhIiwic291cmNlVXJsIjoidHAtMjAyNC5wZGYifV","19"],
                c: ["eyJtaXR0YXJpIjoiI2E4NTVmNyIsInRhcGFodHVtYSI6IiNlYz","Q4OTkifQ=="],
                dl: ["W3siaWQiOiJyOHRxenFyc3ciLCJ1cmwiOiJodHRwczovL3d3dy","5sYXVrYWEuZmkvYXN1a2thYXQvd3AtY29udGVudC91cGxvYWRz","L3NpdGVzLzIvMjAyMS8wNi9UaWxpbnBhYXRvcy0yMDE4LnBkZi","J9LHsiaWQiOiJtYTZzZzQ4bW0iLCJ1cmwiOiJodHRwczovL3d3","dy5sYXVrYWEuZmkvYXN1a2thYXQvd3AtY29udGVudC91cGxvYW","RzL3NpdGVzLzIvMjAyMS8wNi9UaWxpbnBhYXRvcy0yMDE5LnBk","ZiJ9LHsiaWQiOiJvcjE4amFuODEiLCJ1cmwiOiJodHRwczovL3","d3dy5sYXVrYWEuZmkvYXN1a2thYXQvd3AtY29udGVudC91cGxv","YWRzL3NpdGVzLzIvMjAyMS8wNi9UaWxpbnBhYXRvcy0yMDIwLn","BkZiJ9LHsiaWQiOiJtZHRhMjRrMTYiLCJ1cmwiOiJodHRwczov","L3d3dy5sYXVrYWEuZmkvYXN1a2thYXQvd3AtY29udGVudC91cG","xvYWRzL3NpdGVzLzIvMjAyMi8wNi9UUC0yMDIxLWtpcmphX0tW","MDYwNjIwMjIucGRmIn0seyJpZCI6IjkyNmg0aHA3ZiIsInVybC","I6Imh0dHBzOi8vd3d3LmxhdWthYS5maS9hc3Vra2FhdC93cC1j","b250ZW50L3VwbG9hZHMvc2l0ZXMvMi8yMDIzLzA2L3RwLTIwMj","Ita2lyamEta3ZfdmVyc2lvLnBkZiJ9LHsiaWQiOiJ6dzgzbnNy","OXEiLCJ1cmwiOiJodHRwczovL3d3dy5sYXVrYWEuZmkvYXN1a2","thYXQvd3AtY29udGVudC91cGxvYWRzL3NpdGVzLzIvMjAyNC8w","NS90cC0yMDIzLnBkZiJ9LHsiaWQiOiJmOWZ3enN6ZGciLCJ1cm","wiOiJodHRwczovL3d3dy5sYXVrYWEuZmkvYXN1a2thYXQvd3At","Y29udGVudC91cGxvYWRzL3NpdGVzLzIvMjAyNS8wNC90cC0yMD","I0LnBkZiJ9XQ=="],
                sr: ["W10="]
            };

            function _dec(a) {
                return JSON.parse(decodeURIComponent(atob(a.join('')).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join('')));
            }

            const data = _dec(_enc.d);
            const colorMap = _dec(_enc.c);
            const docLinks = _dec(_enc.dl);
            const scrapedResults = _dec(_enc.sr);

            document.getElementById('sum-p').innerText = '"' + data.summary + '"';

            function resolveSourceUrl(source) {
                if (!source) return null;
                const s = source.trim();
                
                function stripTrailingNumbers(str) {
                    return str.replace(/(.(pdf|html|txt|docx|doc|xls|xlsx|png|jpg|jpeg))d+$/i, '$1');
                }

                // 0. Numbered reference check (e.g. "Lähde nro. 1")
                const numberedMatch = s.match(/(?:Lähde|Source)s+nro.?s*(d+)/i);
                if (numberedMatch) {
                    const idx = parseInt(numberedMatch[1], 10) - 1;
                    const validDocs = docLinks.filter(d => d.url.trim());
                    if (idx >= 0 && idx < validDocs.length) return validDocs[idx].url;
                    const scIdx = idx - validDocs.length;
                    if (scIdx >= 0 && scIdx < scrapedResults.length) return scrapedResults[scIdx].url;
                }

                if (s.startsWith('http')) {
                    if (docLinks.find(d => d.url === s)) return s;
                    if (scrapedResults.find(r => r.url === s)) return s;
                    const cleanedUrl = stripTrailingNumbers(s);
                    if (docLinks.find(d => d.url === cleanedUrl)) return cleanedUrl;
                    const scrapedMatch = scrapedResults.find(r => r.url === cleanedUrl);
                    if (scrapedMatch) return scrapedMatch.url;
                    return s;
                }

                const clean = stripTrailingNumbers(s).toLowerCase();
                
                const docMatch = docLinks.find(d => {
                    try {
                        const u = new URL(d.url);
                        const filename = (u.pathname.split('/').pop() || "").toLowerCase();
                        if (filename === clean || stripTrailingNumbers(filename) === clean) return true;
                        return d.url.toLowerCase().includes(clean);
                    } catch(e) { return d.url.toLowerCase().includes(clean); }
                });
                if (docMatch) return docMatch.url;
                
                const scrapeMatch = scrapedResults.find(r => {
                    try {
                        const u = new URL(r.url);
                        const filename = (u.pathname.split('/').pop() || "").toLowerCase() || r.title.toLowerCase();
                        if (filename === clean || stripTrailingNumbers(filename) === clean) return true;
                        return r.url.toLowerCase().includes(clean) || r.title.toLowerCase().includes(clean);
                    } catch(e) { return r.url.toLowerCase().includes(clean) || r.title.toLowerCase().includes(clean); }
                });
                if (scrapeMatch) return scrapeMatch.url;
                
                return null;
            }

            function showInfo(d) {
                document.getElementById("info").style.display = "block";
                document.getElementById("info-title").innerText = d.label;
                document.getElementById("info-type").innerText = d.type;
                document.getElementById("info-desc").innerText = d.description || "Ei kuvausta saatavilla.";
                
                const sourceEl = document.getElementById("info-source");
                const sourceTitle = document.getElementById("info-sources-title");
                
                // Root mindmap section
                const existingMindmap = document.getElementById("info-mindmap");
                if (existingMindmap) existingMindmap.remove();

                if (d.mindmap && d.mindmap.length > 0) {
                    const mmDiv = document.createElement("div");
                    mmDiv.id = "info-mindmap";
                    mmDiv.style.cssText = "margin-top: 20px; padding-top: 20px; border-top: 1px solid #f1f5f9;";
                    mmDiv.innerHTML = '<div style="font-size: 11px; font-weight: 800; color: #94a3b8; text-transform: uppercase; margin-bottom: 12px;">Ajatuskartta / Alisolmut</div>';
                    
                    const mmCont = document.createElement("div");
                    mmCont.style.cssText = "display: flex; flex-direction: column; gap: 10px;";
                    
                    d.mindmap.forEach(sub => {
                        const item = document.createElement("div");
                        item.style.cssText = "background: #f8fafc; padding: 12px; border-radius: 12px; border: 1px solid #f1f5f9;";
                        item.innerHTML = `
                            <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
                                <div style="width: 6px; height: 6px; border-radius: 50%; background: #6366f1;"></div>
                                <span style="font-weight: 800; font-size: 12px; color: #1e293b;">${sub.label}</span>
                                ${sub.type ? `<span style="font-size: 9px; padding: 2px 6px; background: #e2e8f0; color: #64748b; border-radius: 4px; font-weight: 800;">${sub.type}</span>` : ''}
                            </div>
                            <p style="margin: 0; font-size: 11px; color: #475569; line-height: 1.5;">${sub.description || ''}</p>
                        `;
                        mmCont.appendChild(item);
                    });
                    mmDiv.appendChild(mmCont);
                    document.getElementById("info-desc").after(mmDiv);
                }

                if (d.source) {
                    const sources = d.source.split(',').map(s => s.trim()).filter(s => s);
                    if (sources.length > 0) {
                        sourceTitle.style.display = "block";
                        const links = sources.map(s => {
                            const url = resolveSourceUrl(s);
                            if (url) {
                                return '<a href="' + url + '" target="_blank" style="color: #4f46e5; text-decoration: underline; font-size: 12px; font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">' + s + '</a>';
                            }
                            return '<span style="font-size: 12px; color: #64748b;">• ' + s + '</span>';
                        });
                        sourceEl.innerHTML = links.join('');
                    } else {
                        sourceTitle.style.display = "none";
                        sourceEl.innerHTML = "";
                    }
                } else {
                    sourceTitle.style.display = "none";
                    sourceEl.innerHTML = "";
                }
            }

            function getEntityColor(type) {
                const t = type ? type.trim().toLowerCase() : '';
                if (colorMap && colorMap[t]) return colorMap[t];
                if (t.includes('henkil') || t.includes('person') || t.includes('ihminen')) return '#10b981';
                if (t.includes('organisaatio') || t.includes('organization') || t.includes('yhtiö') || t.includes('yritys') || t.includes('yhteisö') || t.includes('company')) return '#3b82f6';
                return '#f59e0b';
            }

            if (true) {
                const container = document.getElementById('timeline-content');
                const sortedNodes = [...data.nodes].sort((a, b) => (a.order || 0) - (b.order || 0));
                
                sortedNodes.forEach((node, index) => {
                    const item = document.createElement('div');
                    item.className = 'timeline-item';
                    
                    const dot = document.createElement('div');
                    dot.className = 'timeline-dot';
                    dot.style.borderColor = getEntityColor(node.type);
                    dot.onclick = () => showInfo(node);
                    
                    const card = document.createElement('div');
                    card.className = 'timeline-card';
                    card.onclick = () => showInfo(node);
                    card.innerHTML = `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px; align-items: center;">
                            <span style="font-size: 10px; font-weight: 800; color: ${getEntityColor(node.type)}; text-transform: uppercase; letter-spacing: 0.05em;">${node.date || 'Vaihe ' + (index + 1)}</span>
                            <span style="font-size: 9px; font-weight: 800; color: #94a3b8; text-transform: uppercase; background: #f8fafc; padding: 2px 6px; border-radius: 4px;">${node.type}</span>
                        </div>
                        <h4 style="margin: 0 0 8px 0; color: #0f172a; font-size: 16px;">${node.label}</h4>
                        <p style="margin: 0; font-size: 13px; color: #475569; line-height: 1.5;">${node.description || ''}</p>
                    `;
                    
                    item.appendChild(dot);
                    item.appendChild(card);
                    
                    const nextNode = sortedNodes[index + 1];
                    if (nextNode) {
                        const edge = data.edges.find(e => e.source === node.id && e.target === nextNode.id);
                        if (edge) {
                            const change = document.createElement('div');
                            change.className = 'timeline-change';
                            change.innerText = "→ " + edge.label;
                            item.appendChild(change);
                        }
                    }
                    container.appendChild(item);
                });
            } else {
                const legCont = document.getElementById('leg-cont');
                Object.entries(colorMap).slice(0, 10).forEach(([type, color]) => {
                    const div = document.createElement('div');
                    div.style.cssText = "display: flex; align-items: center; gap: 8px; margin-bottom: 8px;";
                    div.innerHTML = `<div style="width: 10px; height: 10px; border-radius: 50%; background: ${color}; flex-shrink: 0;"></div><span style="font-weight: 600; text-transform: capitalize; color: #334155;">${type}</span>`;
                    legCont.appendChild(div);
                });

                let width = window.innerWidth;
                let height = window.innerHeight;
                let drillDownNodeId = null;

                const backBtn = document.getElementById('back-btn');
                if (backBtn) {
                    backBtn.addEventListener('mouseover', () => backBtn.style.background = '#f8fafc');
                    backBtn.addEventListener('mouseout', () => backBtn.style.background = 'rgba(255, 255, 255, 0.95)');
                    backBtn.onclick = () => {
                        drillDownNodeId = null;
                        backBtn.style.display = 'none';
                        renderGraph();
                    };
                }

                window.addEventListener('resize', () => {
                    width = window.innerWidth;
                    height = window.innerHeight;
                    const svg = d3.select("#graph svg");
                    if (!svg.empty()) {
                        svg.attr("width", width).attr("height", height);
                    }
                });

                function getDisplayData() {
                    if (!drillDownNodeId) return data;
                    const rootNode = data.nodes.find(n => n.id === drillDownNodeId);
                    if (!rootNode || !rootNode.mindmap) return data;

                    const nodes = [
                        Object.assign({}, rootNode, { mindmap: [] }),
                        ...rootNode.mindmap.map(m => ({
                            id: m.id,
                            label: m.label,
                            description: m.description,
                            type: m.type || 'Subconcept',
                            source: m.source
                        }))
                    ];
                    const edges = rootNode.mindmap.map(m => ({
                        source: rootNode.id,
                        target: m.id,
                        label: 'laajennus'
                    }));
                    return { nodes, edges };
                }

                function renderGraph() {
                    const graphContainer = document.getElementById('graph');
                    const oldSvg = graphContainer.querySelector('svg');
                    if (oldSvg) oldSvg.remove();

                    if (drillDownNodeId && backBtn) {
                        backBtn.style.display = 'block';
                    }

                    const renderData = getDisplayData();
                    // Copy data because D3 mutates nodes/edges
                    const nodesData = JSON.parse(JSON.stringify(renderData.nodes));
                    const edgesData = JSON.parse(JSON.stringify(renderData.edges));

                    const svg = d3.select("#graph").append("svg")
                        .attr("width", width)
                        .attr("height", height)
                        .call(d3.zoom().scaleExtent([0.1, 8]).on("zoom", (event) => g.attr("transform", event.transform)));

                    const g = svg.append("g");

                    svg.append("defs").append("marker")
                        .attr("id", "arrowhead")
                        .attr("viewBox", "-0 -5 10 10")
                        .attr("refX", 25)
                        .attr("refY", 0)
                        .attr("orient", "auto")
                        .attr("markerWidth", 6)
                        .attr("markerHeight", 6)
                        .attr("xoverflow", "visible")
                        .append("svg:path")
                        .attr("d", "M 0,-5 L 10 ,0 L 0,5")
                        .attr("fill", "#cbd5e1");

                    const simulation = d3.forceSimulation(nodesData)
                        .force("link", d3.forceLink(edgesData).id(d => d.id).distance(180))
                        .force("charge", d3.forceManyBody().strength(-600))
                        .force("center", d3.forceCenter(width / 2, height / 2))
                        .force("x", d3.forceX(width / 2).strength(0.07))
                        .force("y", d3.forceY(height / 2).strength(0.07))
                        .force("collision", d3.forceCollide().radius(70));

                    const link = g.append("g").selectAll("line")
                        .data(edgesData).enter().append("line")
                        .attr("class", "link")
                        .attr("marker-end", "url(#arrowhead)");

                    const linkLabels = g.append("g").selectAll("text")
                        .data(edgesData).enter().append("text")
                        .attr("class", "link-label")
                        .text(d => d.label);

                    const node = g.append("g").selectAll("g")
                        .data(nodesData).enter().append("g")
                        .attr("class", "node-group")
                        .style("cursor", "pointer")
                        .on("click", (event, d) => showInfo(d))
                        .call(d3.drag()
                            .on("start", (e, d) => { if (!e.active) simulation.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; })
                            .on("drag", (e, d) => { d.fx = e.x; d.fy = e.y; })
                            .on("end", (e, d) => { if (!e.active) simulation.alphaTarget(0); d.fx = null; d.fy = null; }));

                    node.append("circle")
                        .attr("class", "node")
                        .attr("r", 24)
                        .attr("fill", d => getEntityColor(d.type))
                        .attr("stroke", "#fff")
                        .attr("stroke-width", 3);

                    node.append("text")
                        .attr("class", "label")
                        .attr("text-anchor", "middle")
                        .attr("dy", 42)
                        .text(d => d.label);

                    // Add drill-down icons
                    nodesData.forEach(d => {
                        const origNode = data.nodes.find(n => n.id === d.id);
                        if (origNode && origNode.mindmap && origNode.mindmap.length > 0 && !drillDownNodeId) {
                            const nodeG = node.filter(n => n.id === d.id);
                            const badge = nodeG.append("g")
                                .attr("transform", "translate(15, -15)")
                                .style("cursor", "pointer")
                                .on("click", (event, n) => {
                                    event.stopPropagation();
                                    drillDownNodeId = n.id;
                                    renderGraph();
                                });

                            badge.append("circle")
                                .attr("r", 10)
                                .attr("fill", "#6366f1")
                                .attr("stroke", "white")
                                .attr("stroke-width", 2);

                            badge.append("text")
                                .text("+")
                                .attr("fill", "white")
                                .attr("font-size", "14px")
                                .attr("font-weight", "bold")
                                .attr("text-anchor", "middle")
                                .attr("dy", "5px");
                        }
                    });

                    simulation.on("tick", () => {
                        link.attr("x1", d => d.source.x).attr("y1", d => d.source.y)
                            .attr("x2", d => d.target.x).attr("y2", d => d.target.y);
                        linkLabels.attr("x", d => (d.source.x + d.target.x) / 2).attr("y", d => (d.source.y + d.target.y) / 2);
                        node.attr("transform", d => "translate(" + d.x + "," + d.y + ")");
                    });
                }

                renderGraph();
            }

            // Populate search dropdowns
            function populateSearchSelects() {
                const selA = document.getElementById("search-a");
                const selB = document.getElementById("search-b");
                if(!selA || !selB) return;
                
                let mainGroupA = '<optgroup label="Pääkäsitteet">';
                let mainGroupB = '<optgroup label="Pääkäsitteet">';
                let subGroupA = '<optgroup label="Alakäsitteet (Mindmap)">';
                let subGroupB = '<optgroup label="Alakäsitteet (Mindmap)">';
                
                data.nodes.forEach(n => {
                    mainGroupA += '<option value="' + n.id + '">' + n.label + '</option>';
                    mainGroupB += '<option value="' + n.id + '">' + n.label + '</option>';
                    if(n.mindmap) {
                        n.mindmap.forEach(m => {
                            subGroupA += '<option value="' + m.id + '">' + m.label + '</option>';
                            subGroupB += '<option value="' + m.id + '">' + m.label + '</option>';
                        });
                    }
                });
                
                mainGroupA += '</optgroup>'; mainGroupB += '</optgroup>';
                subGroupA += '</optgroup>'; subGroupB += '</optgroup>';
                
                const html = '<option value="">-- Valitse solmu --</option>' + mainGroupA + subGroupA;
                selA.innerHTML = html;
                selB.innerHTML = html;
            }
            populateSearchSelects();
            
            window.toggleSearchPanel = function() {
                const p = document.getElementById('search-panel');
                p.style.display = p.style.display === 'block' ? 'none' : 'block';
            };
            
            window.updateSearchUI = function() {
                const valA = document.getElementById("search-a").value;
                const valB = document.getElementById("search-b").value;
                document.getElementById("do-search-btn").disabled = !(valA && valB);
                
                const adjacencyList = new Map();
                data.nodes.forEach(n => {
                    if (n.mindmap) {
                        n.mindmap.forEach(m => {
                            if (!adjacencyList.has(n.id)) adjacencyList.set(n.id, []);
                            adjacencyList.get(n.id).push(m.id);
                            if (!adjacencyList.has(m.id)) adjacencyList.set(m.id, []);
                            adjacencyList.get(m.id).push(n.id);
                        });
                    }
                });
                data.edges.forEach(e => {
                    const srcId = typeof e.source === 'object' ? e.source.id : e.source;
                    const tgtId = typeof e.target === 'object' ? e.target.id : e.target;
                    if (!adjacencyList.has(srcId)) adjacencyList.set(srcId, []);
                    adjacencyList.get(srcId).push(tgtId);
                    if (!adjacencyList.has(tgtId)) adjacencyList.set(tgtId, []);
                    adjacencyList.get(tgtId).push(srcId);
                });

                function getReachable(startId) {
                    if(!startId) return null;
                    const visited = new Set();
                    const queue = [{id: startId, d: 0}];
                    visited.add(startId);
                    while(queue.length > 0) {
                        const cur = queue.shift();
                        if(cur.d >= 6) continue;
                        const neighbors = adjacencyList.get(cur.id) || [];
                        for(const n of neighbors) {
                            if(!visited.has(n)) {
                                visited.add(n);
                                queue.push({id: n, d: cur.d + 1});
                            }
                        }
                    }
                    return visited;
                }

                const reachA = getReachable(valA);
                const reachB = getReachable(valB);
                
                const optsA = document.getElementById("search-a").options;
                const optsB = document.getElementById("search-b").options;
                
                for(let i=0; i<optsA.length; i++) {
                    const v = optsA[i].value;
                    if(v === "") continue;
                    let show = true;
                    if (reachB && !reachB.has(v) && v !== valA) show = false;
                    optsA[i].style.display = show ? "" : "none";
                    optsA[i].disabled = (!show) || (v === valB && valB !== "");
                }
                for(let i=0; i<optsB.length; i++) {
                    const v = optsB[i].value;
                    if(v === "") continue;
                    let show = true;
                    if (reachA && !reachA.has(v) && v !== valB) show = false;
                    optsB[i].style.display = show ? "" : "none";
                    optsB[i].disabled = (!show) || (v === valA && valA !== "");
                }
            };
            
            window.clearSearch = function() {
                document.getElementById("search-a").value = "";
                document.getElementById("search-b").value = "";
                document.getElementById("search-results").style.display = "none";
                updateSearchUI();
            };
            
            window.executeSearch = function() {
                const valA = document.getElementById("search-a").value;
                const valB = document.getElementById("search-b").value;
                if(!valA || !valB) return;
                
                const allNodesArray = [];
                const adjacencyList = new Map();

                data.nodes.forEach(n => {
                    allNodesArray.push(n);
                    if (n.mindmap) {
                        n.mindmap.forEach(m => {
                            allNodesArray.push(m);
                            
                            if (!adjacencyList.has(n.id)) adjacencyList.set(n.id, []);
                            adjacencyList.get(n.id).push({ target: m.id, label: 'laajennus' });
                            
                            if (!adjacencyList.has(m.id)) adjacencyList.set(m.id, []);
                            adjacencyList.get(m.id).push({ target: n.id, label: 'laajennus (käänteinen)' });
                        });
                    }
                });

                data.edges.forEach(e => {
                    const srcId = typeof e.source === 'object' ? e.source.id : e.source;
                    const tgtId = typeof e.target === 'object' ? e.target.id : e.target;
                    
                    if (!adjacencyList.has(srcId)) adjacencyList.set(srcId, []);
                    adjacencyList.get(srcId).push({ target: tgtId, label: e.label });

                    if (!adjacencyList.has(tgtId)) adjacencyList.set(tgtId, []);
                    adjacencyList.get(tgtId).push({ target: srcId, label: e.label + ' (käänteinen)' });
                });

                const queue = [];
                const visited = new Set();

                queue.push({ id: valA, path: [{ id: valA }] });
                visited.add(valA);

                let foundPath = null;
                const maxDepth = 6;

                while (queue.length > 0) {
                    const current = queue.shift();
                    if (current.id === valB) { foundPath = current.path; break; }
                    if (current.path.length > maxDepth) continue;

                    const neighbors = adjacencyList.get(current.id) || [];
                    for (const neighbor of neighbors) {
                        if (!visited.has(neighbor.target)) {
                            visited.add(neighbor.target);
                            queue.push({
                                id: neighbor.target,
                                path: [...current.path, { id: neighbor.target, edgeLabel: neighbor.label }]
                            });
                        }
                    }
                }
                
                const resEl = document.getElementById("search-results");
                resEl.style.display = "block";
                
                if (foundPath) {
                    const pathNodes = foundPath.map(p => allNodesArray.find(n => n.id === p.id)).filter(Boolean);
                    let html = '<h4 style="font-size: 10px; font-weight: 800; color: #4f46e5; text-transform: uppercase; margin-bottom: 8px;">Löytynyt yhteys (Syvyys: ' + (pathNodes.length - 1) + ')</h4>';
                    html += '<div style="max-height: 200px; overflow-y: auto; padding-right: 4px;">';
                    
                    for(let i=0; i<pathNodes.length; i++) {
                        const n = pathNodes[i];
                        const color = getEntityColor(n.type);
                        html += '<div style="margin-bottom: 4px;">';
                        html += '<div style="display: flex; align-items: center; gap: 8px;">';
                        html += '<div style="width: 8px; height: 8px; border-radius: 50%; background: ' + color + ';"></div>';
                        html += '<span style="font-size: 12px; font-weight: bold; color: #1e293b;">' + n.label + '</span>';
                        html += '</div>';
                        
                        if (i < foundPath.length - 1) {
                            const edgeLabel = foundPath[i+1].edgeLabel || 'yhteys';
                            html += '<div style="margin-left: 3px; border-left: 2px solid #e0e7ff; padding-left: 14px; padding-top: 4px; padding-bottom: 4px; margin-top: 4px; margin-bottom: 4px;">';
                            html += '<span style="font-size: 10px; font-weight: bold; color: #6366f1; background: #eef2ff; padding: 2px 6px; border-radius: 6px; word-break: break-all;">' + edgeLabel + '</span>';
                            html += '</div>';
                        }
                        html += '</div>';
                    }
                    html += '</div>';
                    resEl.innerHTML = html;
                } else {
                    resEl.innerHTML = '<div style="font-size: 12px; color: #ef4444; font-weight: bold; padding: 10px; background: #fef2f2; border-radius: 8px;">Yhteyttä ei löytynyt annettujen solmujen välillä (maksimisyvyys 6).</div>';
                }
            };
        })();
    </script>
</body>
</html>