document.addEventListener("DOMContentLoaded",()=>{const e=L.map("tarina-map").setView([62.336,26.046],10);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap contributors"}).addTo(e);let t=[],n=[],o=0,a=[],l=null;const i=document.getElementById("select-category"),r=document.getElementById("select-topic"),s=document.getElementById("select-story"),c=document.getElementById("step-title"),d=document.getElementById("step-counter"),p=document.getElementById("step-description"),u=document.getElementById("step-image"),m=document.getElementById("image-placeholder"),y=document.getElementById("prev-btn"),g=document.getElementById("next-btn");function h(e,n){let o=t;e&&(o=o.filter(t=>t.category===e)),n&&(o=o.filter(e=>e.topic===n)),s.innerHTML='<option value="">Kaikki tarinat</option>',o.forEach(e=>{const t=document.createElement("option");t.value=e.step_order,t.textContent=e.story_name||e.title,s.appendChild(t)}),s.disabled=0===o.length}function f(){const o=i.value,s=r.value;n=t.filter(e=>(!o||e.category===o)&&(!s||e.topic===s)),function(){a.forEach(t=>e.removeLayer(t)),a=[],l&&(e.removeLayer(l),l=null);const t=[];n.forEach((n,o)=>{const l=parseFloat(n.lat),i=parseFloat(n.lng);if(isNaN(l)||isNaN(i))return;const r=L.marker([l,i],{icon:L.divIcon({className:"custom-div-icon",html:`<div style="background-color:#0056b3; color:white; border-radius:50%; width:28px; height:28px; display:flex; align-items:center; justify-content:center; border:2px solid white; font-weight:bold; font-size:0.8rem; box-shadow:0 2px 6px rgba(0,0,0,0.3);">${o+1}</div>`,iconSize:[28,28],iconAnchor:[14,14]})}).addTo(e);r.on("click",()=>v(o)),a.push(r),t.push([l,i])}),t.length>1?(l=L.polyline(t,{color:"#0056b3",weight:3,opacity:.5,dashArray:"6, 10"}).addTo(e),e.fitBounds(L.latLngBounds(t).pad(.15))):1===t.length&&e.flyTo(t[0],13)}(),n.length>0?v(0):(c.textContent="Ei tarinoita valinnalla",d.textContent="0 / 0",p.textContent="Valitse eri teema tai aihe.",u.style.display="none",m.style.display="block")}function v(t){if(t<0||t>=n.length)return;o=t;const l=n[t];c.textContent=l.title,d.textContent=`Askel ${t+1} / ${n.length}`,p.textContent=l.description,s.value=l.step_order,l.image_url&&l.image_url.trim()?(u.src=l.image_url,u.style.display="block",u.style.opacity="0",u.onload=()=>{u.style.opacity="1"},m.style.display="none"):(u.style.display="none",m.style.display="block");const i=parseFloat(l.lat),r=parseFloat(l.lng);isNaN(i)||isNaN(r)||e.flyTo([i,r],13,{duration:1.2}),a.forEach((e,n)=>{const o=e.getElement();if(!o)return;const a=o.querySelector("div");a&&(a.style.backgroundColor=n===t?"#e85d04":"#0056b3",a.style.transform=n===t?"scale(1.3)":"scale(1)",a.style.transition="all 0.2s ease"),e.setZIndexOffset(n===t?1e3:0)}),y.disabled=0===t,g.disabled=t===n.length-1}Papa.parse("tarinakartta_data.csv",{download:!0,header:!0,skipEmptyLines:!0,complete:function(e){t=e.data.sort((e,t)=>parseInt(e.step_order)-parseInt(t.step_order)),t.length>0&&(!function(){const e=[...new Set(t.map(e=>e.category).filter(Boolean))].sort();i.innerHTML='<option value="">Kaikki teemat</option>',e.forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,i.appendChild(t)})}(),f())},error:function(e){console.error("Virhe tarinadatan latauksessa:",e),c.textContent="Virhe datan latauksessa"}}),i.addEventListener("change",()=>{const e=i.value;!function(e){const n=e?t.filter(t=>t.category===e):t,o=[...new Set(n.map(e=>e.topic).filter(Boolean))].sort();r.innerHTML='<option value="">Kaikki aiheet</option>',o.forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,r.appendChild(t)}),r.disabled=0===o.length}(e),h(e,""),s.value="",f()}),r.addEventListener("change",()=>{h(i.value,r.value),s.value="",f()}),s.addEventListener("change",()=>{const e=s.value;if(e){const t=n.findIndex(t=>t.step_order===e);t>=0&&v(t)}else f()}),y.addEventListener("click",()=>v(o-1)),g.addEventListener("click",()=>v(o+1))});