document.addEventListener("DOMContentLoaded",()=>{const e=L.map("tarina-map").setView([62.336,26.046],10);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap contributors"}).addTo(e);let t=[],n=[],o=0,a=[],i=null;const l=document.getElementById("select-category"),r=document.getElementById("select-topic"),s=document.getElementById("select-story"),d=document.getElementById("step-title"),c=document.getElementById("step-counter"),p=document.getElementById("step-description"),u=document.getElementById("step-image"),m=document.getElementById("image-placeholder"),y=document.getElementById("prev-btn"),g=document.getElementById("next-btn"),h=document.getElementById("step-more-info");function f(e,n){let o=t;e&&(o=o.filter(t=>t.category===e)),n&&(o=o.filter(e=>e.topic===n)),s.innerHTML='<option value="">Kaikki tarinat</option>',o.forEach(e=>{const t=document.createElement("option");t.value=e.step_order,t.textContent=e.story_name||e.title,s.appendChild(t)}),s.disabled=0===o.length}function v(){const o=l.value,s=r.value;n=t.filter(e=>(!o||e.category===o)&&(!s||e.topic===s)),function(){a.forEach(t=>e.removeLayer(t)),a=[],i&&(e.removeLayer(i),i=null);const t=[];n.forEach((n,o)=>{const i=parseFloat(n.lat),l=parseFloat(n.lng);if(isNaN(i)||isNaN(l))return;const r=L.marker([i,l],{icon:L.divIcon({className:"custom-div-icon",html:`<div style="background-color:#0056b3; color:white; border-radius:50%; width:28px; height:28px; display:flex; align-items:center; justify-content:center; border:2px solid white; font-weight:bold; font-size:0.8rem; box-shadow:0 2px 6px rgba(0,0,0,0.3);">${o+1}</div>`,iconSize:[28,28],iconAnchor:[14,14]})}).addTo(e);r.on("click",()=>E(o)),a.push(r),t.push([i,l])}),t.length>1?(i=L.polyline(t,{color:"#0056b3",weight:3,opacity:.5,dashArray:"6, 10"}).addTo(e),e.fitBounds(L.latLngBounds(t).pad(.15))):1===t.length&&e.flyTo(t[0],13)}(),n.length>0?E(0):(d.textContent="Ei tarinoita valinnalla",c.textContent="0 / 0",p.textContent="Valitse eri teema tai aihe.",u.style.display="none",m.style.display="block")}function E(t){if(t<0||t>=n.length)return;o=t;const i=n[t];if(d.textContent=i.title,c.textContent=`Askel ${t+1} / ${n.length}`,p.textContent=i.description,s.value=i.step_order,i.image_url&&i.image_url.trim()){let e=i.image_url.trim();if(e.includes("drive.google.com")||e.includes("drive_cache/")){const t=e.match(/(?:id=|\/d\/|file\/d\/|drive_cache\/)([a-zA-Z0-9_-]+)/);t&&(e=`get_image.php?id=${t[1]}`)}u.src=e,u.style.display="block",u.style.opacity="0",u.onload=()=>{u.style.opacity="1"},m.style.display="none"}else u.style.display="none",m.style.display="block";i.more_info_url&&i.more_info_url.trim()?(h.href=i.more_info_url,h.style.display="block"):h.style.display="none";const l=parseFloat(i.lat),r=parseFloat(i.lng);isNaN(l)||isNaN(r)||e.flyTo([l,r],13,{duration:1.2}),a.forEach((e,n)=>{const o=e.getElement();if(!o)return;const a=o.querySelector("div");a&&(a.style.backgroundColor=n===t?"#e85d04":"#0056b3",a.style.transform=n===t?"scale(1.3)":"scale(1)",a.style.transition="all 0.2s ease"),e.setZIndexOffset(n===t?1e3:0)}),y.disabled=0===t,g.disabled=t===n.length-1}Papa.parse("tarinakartta_data.csv",{download:!0,header:!0,skipEmptyLines:!0,complete:function(e){t=e.data.sort((e,t)=>parseInt(e.step_order)-parseInt(t.step_order)),t.length>0&&(!function(){const e=[...new Set(t.map(e=>e.category).filter(Boolean))].sort();l.innerHTML='<option value="">Kaikki teemat</option>',e.forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,l.appendChild(t)})}(),v())},error:function(e){console.error("Virhe tarinadatan latauksessa:",e),d.textContent="Virhe datan latauksessa"}}),l.addEventListener("change",()=>{const e=l.value;!function(e){const n=e?t.filter(t=>t.category===e):t,o=[...new Set(n.map(e=>e.topic).filter(Boolean))].sort();r.innerHTML='<option value="">Kaikki aiheet</option>',o.forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,r.appendChild(t)}),r.disabled=0===o.length}(e),f(e,""),s.value="",v()}),r.addEventListener("change",()=>{f(l.value,r.value),s.value="",v()}),s.addEventListener("change",()=>{const e=s.value;if(e){const t=n.findIndex(t=>t.step_order===e);t>=0&&E(t)}else v()}),y.addEventListener("click",()=>E(o-1)),g.addEventListener("click",()=>E(o+1))});