document.addEventListener("DOMContentLoaded",()=>{const e=L.map("muisto-map").setView([62.336,26.046],10);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap contributors"}).addTo(e);const t=L.markerClusterGroup({chunkedLoading:!0,maxClusterRadius:50});e.addLayer(t);let n=[],a=[],i=-1;const o=document.getElementById("filter-area"),r=document.getElementById("filter-decade"),s=document.getElementById("search-input"),l=document.getElementById("tag-suggestions");function d(e){if(!e||e.length<2)return void c();const t=e.startsWith("#")?e.slice(1).toLowerCase():e.toLowerCase(),n=a.filter(e=>e.includes(t));0!==n.length?(i=-1,l.innerHTML="",n.slice(0,10).forEach((e,n)=>{const a=document.createElement("div");a.className="tag-suggestion-item",a.setAttribute("role","option"),a.setAttribute("data-index",n);const i=e.replace(new RegExp(`(${o=t,o.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")})`,"gi"),'<span class="tag-match">$1</span>');var o;a.innerHTML=`<span class="tag-hash">#</span>${i}`,a.addEventListener("mousedown",t=>{t.preventDefault(),p(e)}),l.appendChild(a)}),l.classList.add("visible")):c()}function c(){l.classList.remove("visible"),l.innerHTML="",i=-1}function p(e){s.value=e,c(),m(),s.focus()}function u(e){e.forEach((e,t)=>{e.classList.toggle("active",t===i)})}function m(){t.clearLayers();const e=o.value,a=r.value,i=s.value.toLowerCase().replace(/^#/,""),l=n.filter(t=>{if(e&&t.area!==e)return!1;if(a&&t.decade!==a)return!1;if(i){if(!`${t.title} ${t.description} ${t.topics} ${t.author}`.toLowerCase().includes(i))return!1}return!0}),d=[];l.forEach(e=>{const t=parseFloat(e.lat),n=parseFloat(e.lng);if(isNaN(t)||isNaN(n))return;const a=L.marker([t,n]);let i=`\n                <div style="font-family: inherit; max-width: 260px;">\n                    <h3 style="margin: 0 0 5px 0; color: #0056b3; font-size: 1.05rem;">${g(e.title)}</h3>\n                    <div style="margin-bottom: 8px; font-size: 0.82rem; color: #666; font-weight: 500;">\n                        üìç ${g(e.area)} &nbsp;|&nbsp; üìÖ ${g(e.decade)}\n                    </div>\n                    <p style="margin: 0 0 10px 0; font-size: 0.92rem; line-height: 1.45;">${g(e.description)}</p>\n                    <div style="margin-bottom: 8px; font-size: 0.82rem; color: #555;"><i>Tarinan kertoja: ${g(e.author)}</i></div>\n            `;if(e.topics){i+=`<div style="margin-bottom: 10px;">${e.topics.split(";").map(e=>`<span style="display:inline-block; background:#e9f0fa; color:#0056b3; padding:2px 7px; border-radius:12px; font-size:0.75rem; margin:0 4px 4px 0; cursor:pointer; font-weight:600;" onclick="document.getElementById('search-input').value='${g(e.trim())}'; document.getElementById('search-input').dispatchEvent(new Event('input'));">#${g(e.trim())}</span>`).join("")}</div>`}(e.youtube||e.filelink)&&(i+='<div style="display:flex; gap:8px; margin-top:10px;">',e.youtube&&(i+=`<a href="${encodeURI(e.youtube)}" target="_blank" style="background:#ff0000; color:white; text-decoration:none; padding:4px 8px; border-radius:4px; font-size:0.8rem; font-weight:bold;">üé• YouTube</a>`),e.filelink&&(i+=`<a href="${encodeURI(e.filelink)}" target="_blank" style="background:#0056b3; color:white; text-decoration:none; padding:4px 8px; border-radius:4px; font-size:0.8rem; font-weight:bold;">üîó Linkki</a>`),i+="</div>"),i+="</div>",a.bindPopup(i),d.push(a)}),t.addLayers(d)}function g(e){return e?e.toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"):""}Papa.parse("muistokartta_data.csv",{download:!0,header:!0,skipEmptyLines:!0,complete:function(e){n=e.data,function(){const e=[...new Set(n.map(e=>e.area).filter(e=>e))].sort(),t=[...new Set(n.map(e=>e.decade).filter(e=>e))].sort();e.forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,o.appendChild(t)}),t.forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,r.appendChild(t)})}(),function(){const e=new Set;n.forEach(t=>{t.topics&&t.topics.split(";").forEach(t=>{const n=t.trim().toLowerCase();n&&e.add(n)})}),a=[...e].sort()}(),m()},error:function(e){console.error("Virhe CSV-tiedoston lukemisessa:",e),document.getElementById("muisto-map").innerHTML='<div style="padding: 20px; text-align: center; color: red;">Virhe aineiston lataamisessa. Varmista ett√§ olet paikallisella palvelimella (CORS).</div>'}}),s.addEventListener("keydown",e=>{const t=l.querySelectorAll(".tag-suggestion-item");l.classList.contains("visible")&&0!==t.length&&("ArrowDown"===e.key?(e.preventDefault(),i=Math.min(i+1,t.length-1),u(t)):"ArrowUp"===e.key?(e.preventDefault(),i=Math.max(i-1,-1),u(t)):"Enter"===e.key&&i>=0?(e.preventDefault(),p(t[i].textContent.replace("#","").trim())):"Escape"===e.key&&c())}),o.addEventListener("change",m),r.addEventListener("change",m),s.addEventListener("input",()=>{m(),d(s.value)}),s.addEventListener("blur",()=>{setTimeout(c,150)}),s.addEventListener("focus",()=>{s.value.length>=2&&d(s.value)})});