document.addEventListener("DOMContentLoaded",()=>{const e=L.map("muisto-map").setView([62.336,26.046],10);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap contributors"}).addTo(e);const t=L.markerClusterGroup({chunkedLoading:!0,maxClusterRadius:50});e.addLayer(t);let n=[];const a=document.getElementById("filter-area"),i=document.getElementById("filter-decade"),o=document.getElementById("search-input");function r(){t.clearLayers();const e=a.value,r=i.value,l=o.value.toLowerCase(),s=n.filter(t=>{if(e&&t.area!==e)return!1;if(r&&t.decade!==r)return!1;if(l){if(!`${t.title} ${t.description} ${t.topics} ${t.author}`.toLowerCase().includes(l))return!1}return!0}),p=[];s.forEach(e=>{const t=parseFloat(e.lat),n=parseFloat(e.lng);if(isNaN(t)||isNaN(n))return;const a=L.marker([t,n]);let i=`\n                <div style="font-family: inherit; max-width: 250px;">\n                    <h3 style="margin: 0 0 5px 0; color: #0056b3; font-size: 1.1rem;">${d(e.title)}</h3>\n                    <div style="margin-bottom: 8px; font-size: 0.85rem; color: #666; font-weight: 500;">\n                        ğŸ“ ${d(e.area)} &nbsp;|&nbsp; ğŸ“… ${d(e.decade)}\n                    </div>\n                    <p style="margin: 0 0 10px 0; font-size: 0.95rem; line-height: 1.4;">${d(e.description)}</p>\n                    <div style="margin-bottom: 10px; font-size: 0.85rem; color: #555;"><i>Tarinan kertoja: ${d(e.author)}</i></div>\n            `;if(e.topics){i+=`<div style="margin-bottom: 10px;">${e.topics.split(";").map(e=>`<span style="display:inline-block; background:#f0f0f0; padding:2px 6px; border-radius:4px; font-size:0.75rem; margin:0 4px 4px 0;">#${d(e.trim())}</span>`).join("")}</div>`}(e.youtube||e.filelink)&&(i+='<div style="display:flex; gap:8px; margin-top:10px;">',e.youtube&&(i+=`<a href="${encodeURI(e.youtube)}" target="_blank" style="background:#ff0000; color:white; text-decoration:none; padding:4px 8px; border-radius:4px; font-size:0.8rem; font-weight:bold;">ğŸ¥ YouTube</a>`),e.filelink&&(i+=`<a href="${encodeURI(e.filelink)}" target="_blank" style="background:#0056b3; color:white; text-decoration:none; padding:4px 8px; border-radius:4px; font-size:0.8rem; font-weight:bold;">ğŸ”— Linkki</a>`),i+="</div>"),i+="</div>",a.bindPopup(i),p.push(a)}),t.addLayers(p),p.length}function d(e){return e?e.toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"):""}Papa.parse("muistokartta_data.csv",{download:!0,header:!0,skipEmptyLines:!0,complete:function(e){n=e.data,function(){const e=[...new Set(n.map(e=>e.area).filter(e=>e))].sort(),t=[...new Set(n.map(e=>e.decade).filter(e=>e))].sort();e.forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,a.appendChild(t)}),t.forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,i.appendChild(t)})}(),r()},error:function(e){console.error("Virhe CSV-tiedoston lukemisessa:",e),document.getElementById("muisto-map").innerHTML='<div style="padding: 20px; text-align: center; color: red;">Virhe aineiston lataamisessa. Varmista ettÃ¤ olet paikallisella palvelimella (CORS).</div>'}}),a.addEventListener("change",r),i.addEventListener("change",r),o.addEventListener("input",r)});