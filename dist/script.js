let allCompanies=[],currentCompany=null,currentMediaIndex=0,map=null,markers=null;const welcomeCompany={id:"welcome",nimi:"Tervetuloa Laukaan yrityshakuun",mainoslause:"L√∂yd√§ paikalliset palvelut, yritt√§j√§t ja el√§mykset.",esittely:"T√§m√§ on Laukaan yrityshaku. Valitse haluamasi yritys listalta tai k√§yt√§ hakua l√∂yt√§√§ksesi etsim√§si palvelut. Voit my√∂s suodattaa yrityksi√§ toimialan mukaan.",osoite:"Laukaa",puhelin:"",email:"",nettisivu:"",karttalinkki:"",media:[{type:"image",url:"icons/icon-512.png"}]};document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("hamburger-btn"),t=document.getElementById("close-sidebar-btn"),n=document.getElementById("sidebar-menu"),a=document.getElementById("sidebar-overlay"),i=document.querySelectorAll(".submenu-toggle"),o=document.querySelectorAll(".sidebar-link:not(.disabled-link)");function l(){n&&n.classList.remove("active"),a&&a.classList.remove("active")}e&&e.addEventListener("click",function(){n&&n.classList.add("active"),a&&a.classList.add("active")}),t&&t.addEventListener("click",l),a&&a.addEventListener("click",l),i.forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();const n=e.parentElement,a=n.querySelector(".submenu");n.classList.toggle("open"),a&&a.classList.toggle("open")})}),o.forEach(e=>{e.addEventListener("click",()=>{l()})}),initRSSFeeds(),loadCompanyData()});const categoryColors={"Kauneus ja terveys":"#ff4d94","Matkailu & El√§mykset":"#00cc66","Ravinto & Vapaa-aika":"#ff9900","Perinnematkailu & Juhlat":"#996633",Muu:"#0056b3"};function initMap(e){map||(map=L.map("company-map").setView([62.4128,25.9477],11),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(map),markers=L.markerClusterGroup(),addMarkersToMap(e),map.addLayer(markers))}function addMarkersToMap(e){markers.clearLayers();const t=[];let n=0;e.forEach(e=>{if(e.lat&&e.lon){const a=parseFloat(e.lat),i=parseFloat(e.lon);if(!isNaN(a)&&!isNaN(i)){n++;const o=`\n                    <div style="\n                        background-color: ${categoryColors[e.kategoria]||"#0056b3"};\n                        width: 20px;\n                        height: 20px;\n                        border-radius: 50% 50% 50% 0;\n                        transform: rotate(-45deg);\n                        border: 2px solid white;\n                        box-shadow: 0 2px 5px rgba(0,0,0,0.3);\n                    "></div>\n                `,l=L.divIcon({html:o,className:"custom-marker",iconSize:[20,20],iconAnchor:[10,20],popupAnchor:[0,-20]}),s=L.marker([a,i],{icon:l});s.bindPopup(`\n                    <div style="font-family: 'Outfit', sans-serif; min-width: 150px;">\n                        <h4 style="margin: 0 0 5px 0; color: #0056b3;">${e.nimi}</h4>\n                        <div style="font-size: 0.8rem; margin-bottom: 8px; color: #666;">${e.kategoria}</div>\n                        <button onclick="selectFromMap('${e.id}')" style="\n                            background: #0056b3;\n                            color: white;\n                            border: none;\n                            padding: 5px 10px;\n                            border-radius: 4px;\n                            cursor: pointer;\n                            width: 100%;\n                            font-size: 0.8rem;\n                        ">N√§yt√§ tiedot</button>\n                    </div>\n                `),markers.addLayer(s),t.push([a,i])}}}),console.log(`Kartta: Lis√§tty ${n} markeria ${e.length} yrityksest√§.`),t.length>0?map.fitBounds(t,{padding:[50,50]}):console.warn("Kartta: Ei l√∂ytynyt yrityksi√§, joilla on validit koordinaatit.")}function selectFromMap(e){const t=allCompanies.find(t=>t.id===e);t&&(updateSpotlight(t),document.querySelectorAll(".catalog-item").forEach(e=>{e.onclick.toString().includes(t.id)||e.textContent.includes(t.nimi)?(e.classList.add("active"),e.scrollIntoView({behavior:"smooth",block:"center"})):e.classList.remove("active")}),document.getElementById("company-spotlight").scrollIntoView({behavior:"smooth"}))}function initRSSFeeds(){fetchRSSFeed("https://www.laukaa.fi/asukkaat/kategoria/uutiset/feed/",document.getElementById("news-container"),"Ei uusia uutiset t√§ll√§ hetkell√§.","utf-8"),fetchRSSFeed("https://laukaa.oncloudos.com/cgi/DREQUEST.PHP?page=rss/meetingitems&show=30",document.getElementById("decisions-container"),"Ei uusia p√§√§t√∂ksi√§.","iso-8859-1"),fetchRSSFeed("https://visitlaukaa.fi/evofeed",document.getElementById("events-container"),"Ei tulevia tapahtumia.","utf-8"),fetchRSSFeed("https://laukaa.trimblefeedback.com/eFeedback/API/Feed/rss",document.getElementById("feedback-container"),"Ei uusia palautteita.","utf-8")}async function fetchRSSFeed(e,t,n,a="utf-8"){const i=[`https://www.mediazoo.fi/laukaainfo-web/proxy.php?url=${encodeURIComponent(e)}&encoding=${a}`,`proxy.php?url=${encodeURIComponent(e)}&encoding=${a}`,`https://api.allorigins.win/get?url=${encodeURIComponent(e)}`,`https://thingproxy.freeboard.io/fetch/${e}`];let o=null;for(const l of i)try{console.log(`Yritet√§√§n hakea RSS: ${e} k√§ytt√§en proxya: ${l}`);const i=await fetch(l);if(!i.ok)throw new Error(`HTTP virhe: ${i.status}`);const o=await i.arrayBuffer(),s=l.includes("proxy.php")?"utf-8":a;let r=new TextDecoder(s).decode(o);if(l.includes("allorigins.win/get"))try{const e=JSON.parse(r);e.contents&&(r=e.contents)}catch(e){console.warn("Allorigins JSON parsimisvirhe:",e)}const c=(new DOMParser).parseFromString(r,"text/xml");if(c.querySelector("parsererror")){console.warn(`Parsintavirhe proxyn ${l} kanssa, kokeillaan seuraavaa.`);continue}const d=c.querySelectorAll("item").length>0?c.querySelectorAll("item"):c.querySelectorAll("entry");if(t.innerHTML="",0===d.length)return void(t.innerHTML=`<p>${n}</p>`);const u=[],m=new Set,p=new Date,g=new Date(p.getFullYear(),p.getMonth(),p.getDate());for(let n=0;n<d.length;n++){const a=d[n],i=(a.querySelector("title")?.textContent||"Ei otsikkoa").trim(),o=a.querySelector("link")?.textContent||a.querySelector("link")?.getAttribute("href")||"#";let l=null;if(e.includes("evofeed")){const e=(a.querySelector("description")?.textContent||a.querySelector("content\\:encoded")?.textContent||"").match(/START:\s*[^,]*,\s*(\d{1,2})\s*([a-z√§√∂]{3,6})\s*(\d{4})\s*(\d{2}:\d{2}:\d{2})/i);if(e){const t=parseInt(e[1]),n=e[2].toLowerCase(),a=parseInt(e[3]),i=e[4],o={tammi:0,helmi:1,maali:2,huhti:3,touko:4,"kes√§":5,"hein√§":6,elo:7,syys:8,loka:9,marras:10,joulu:11};let s=-1;for(const e in o)if(n.startsWith(e)){s=o[e];break}if(-1!==s){const[e,n,o]=i.split(":").map(Number);l=new Date(a,s,t,e,n,o)}}}if(!l){const e=a.querySelector("pubDate")||a.querySelector("published")||a.querySelector("updated")||a.querySelector("dc\\:date");if(e)try{l=new Date(e.textContent)}catch(e){l=null}}if("events-container"===t.id&&l&&!isNaN(l)&&l<g)continue;const s=i.toLowerCase();if(m.has(s))continue;m.add(s);let r="";const c=a.querySelector("enclosure"),p=a.querySelector("content[url]")||a.querySelector("thumbnail");if(c&&c.getAttribute("type")?.includes("image"))r=c.getAttribute("url");else if(p)r=p.getAttribute("url");else{const e=(a.querySelector("description")?.textContent||"").match(/<img[^>]+src="([^">]+)"/);e&&(r=e[1])}const y=a.querySelector("description")||a.querySelector("summary")||a.querySelector("content");let h=y?y.textContent:"";h=h.replace(/<[^>]*>/g," ").trim(),e.includes("evofeed")&&(h=h.replace(/START:.*END:.*(?= )/g,"").trim()),h=h.substring(0,120)+(h.length>120?"...":""),u.push({title:i,link:o,date:l,imageUrl:r,description:h,dateStr:l&&!isNaN(l)?l.toLocaleDateString("fi-FI"):""})}"events-container"===t.id&&u.sort((e,t)=>{const n=e.date&&!isNaN(e.date),a=t.date&&!isNaN(t.date);return n||a?n?a?e.date.getTime()-t.date.getTime():-1:1:0});const y=5,h=u.slice(0,y);for(const e of h){const n=document.createElement("div");n.className="rss-item",n.innerHTML=`\n                    ${e.imageUrl?`<img src="${e.imageUrl}" class="rss-item-image" loading="lazy">`:""}\n                    <div class="rss-meta"><span class="date">üìÖ ${e.dateStr}</span></div>\n                    <h3><a href="${e.link}" target="_blank">${e.title}</a></h3>\n                    <p class="description">${e.description}</p>\n                `,t.appendChild(n)}return}catch(e){console.warn(`Proxy ${l} ep√§onnistui:`,e),o=e}console.error(`Kaikki RSS-haut ep√§onnistuivat: ${e}`,o),t.innerHTML="<p>Tietojen lataus ep√§onnistui (CORS/Network error).</p>"}async function loadCompanyData(){console.log("Yritet√§√§n hakea yritystietoja: get_companies.php");try{const e=await fetch("https://www.mediazoo.fi/laukaainfo-web/get_companies.php?t="+Date.now());console.log("Vastaus saatu:",e.status,e.statusText);const t=await e.text();console.log("Raw data pituus:",t.length);try{allCompanies=JSON.parse(t)}catch(e){throw console.error("JSON parsimisvirhe. Data ei ole validia JSONia:",t.substring(0,200)),e}console.log("Yrityksi√§ ladattu:",allCompanies.length),allCompanies.length>0&&allCompanies[0]._debug_headers&&console.log("CSV Sarakkeet:",allCompanies[0]._debug_headers.join(", ")),console.log("Esimerkki koordinaateista (ensimm√§iset 5):"),allCompanies.slice(0,5).forEach(e=>{console.log(`- ${e.nimi}: lat="${e.lat}", lon="${e.lon}"`)}),initCompanyCatalog(),initMap(allCompanies),console.log("P√§ivitet√§√§n spotlight avaustilanteella"),updateSpotlight(welcomeCompany)}catch(e){console.error("Yritystietojen haku ep√§onnistui:",e),document.getElementById("catalog-list").innerHTML=`<p style="padding: 1rem; color: #dc3545;">Virhe ladattaessa tietoja: ${e.message}</p>`}}let deferredPrompt,activeSuggestionIndex=-1,filteredSuggestions=[];function initCompanyCatalog(){const e=document.getElementById("company-search"),t=document.getElementById("category-filter"),n=document.getElementById("search-suggestions");[...new Set(allCompanies.map(e=>e.kategoria))].sort().forEach(e=>{const n=document.createElement("option");n.value=e,n.textContent=e,t.appendChild(n)}),e.addEventListener("input",()=>{filterCatalog(),showSuggestions()}),e.addEventListener("keydown",handleSearchKeydown),t.addEventListener("change",()=>{filterCatalog()}),document.addEventListener("click",t=>{e.contains(t.target)||n.contains(t.target)||(n.style.display="none")}),renderCatalog(allCompanies)}function filterCatalog(){const e=(document.getElementById("company-search").value||"").toLowerCase().trim(),t=document.getElementById("category-filter").value,n=allCompanies.filter(n=>{const a=(n.nimi||"").toLowerCase(),i=(n.mainoslause||"").toLowerCase(),o=(n.esittely||"").toLowerCase(),l=a.includes(e)||i.includes(e)||o.includes(e),s="all"===t||n.kategoria===t;return l&&s});filteredSuggestions=n.slice(0,8),renderCatalog(n),map&&markers&&addMarkersToMap(n)}function showSuggestions(){const e=document.getElementById("search-suggestions"),t=document.getElementById("company-search").value.trim();t.length<1||0===filteredSuggestions.length?e.style.display="none":(e.innerHTML="",activeSuggestionIndex=-1,filteredSuggestions.forEach((n,a)=>{const i=document.createElement("li"),o=new RegExp(`(${t})`,"gi"),l=n.nimi.replace(o,"<mark>$1</mark>");i.innerHTML=`\n            <span>${l}</span>\n            <span class="suggestion-cat">${n.kategoria}</span>\n        `,i.onclick=()=>{selectSuggestion(n)},e.appendChild(i)}),e.style.display="block")}function handleSearchKeydown(e){const t=document.getElementById("search-suggestions"),n=t.querySelectorAll("li");"none"!==t.style.display&&("ArrowDown"===e.key?(e.preventDefault(),activeSuggestionIndex=(activeSuggestionIndex+1)%n.length,updateActiveSuggestion(n)):"ArrowUp"===e.key?(e.preventDefault(),activeSuggestionIndex=(activeSuggestionIndex-1+n.length)%n.length,updateActiveSuggestion(n)):"Enter"===e.key?activeSuggestionIndex>-1&&(e.preventDefault(),selectSuggestion(filteredSuggestions[activeSuggestionIndex])):"Escape"===e.key&&(t.style.display="none"))}function updateActiveSuggestion(e){e.forEach((e,t)=>{e.classList.toggle("selected",t===activeSuggestionIndex),t===activeSuggestionIndex&&e.scrollIntoView({block:"nearest"})})}function selectSuggestion(e){const t=document.getElementById("company-search"),n=document.getElementById("search-suggestions");t.value=e.nimi,n.style.display="none",filterCatalog(),updateSpotlight(e),document.querySelectorAll(".catalog-item").forEach(t=>{t.querySelector("h4").textContent===e.nimi?(t.classList.add("active"),t.scrollIntoView({behavior:"smooth",block:"center"})):t.classList.remove("active")})}function renderCatalog(e){const t=document.getElementById("catalog-list");t.innerHTML="",0!==e.length?e.forEach(e=>{const n=document.createElement("div");n.className="catalog-item",currentCompany&&currentCompany.id===e.id&&n.classList.add("active"),n.innerHTML=`<h4>${e.nimi}</h4><span class="cat-tag">${e.kategoria}</span>`,n.onclick=()=>{document.querySelectorAll(".catalog-item").forEach(e=>e.classList.remove("active")),n.classList.add("active"),updateSpotlight(e)},t.appendChild(n)}):t.innerHTML='<p style="padding: 1rem; opacity: 0.6;">Ei l√∂ytynyt yrityksi√§.</p>'}function updateSpotlight(e){if(!e)return;console.log("P√§ivitet√§√§n spotlight:",e.nimi,"Mediaa:",e.media?e.media.length:0),currentCompany=e,currentMediaIndex=0,document.getElementById("spotlight-name").textContent=e.nimi,document.getElementById("spotlight-tagline").textContent=e.mainoslause,document.getElementById("spotlight-desc").textContent=e.esittely||e.mainoslause,document.getElementById("spotlight-details").innerHTML=`\n        <div>üìç ${e.osoite}</div>\n        <div>üìû ${e.puhelin||"-"}</div>\n        <div>üìß ${e.email||"-"}</div>\n    `;let t="";e.nettisivu&&(t+=`<a href="${e.nettisivu}" target="_blank" class="btn-primary">üåê Kotisivut</a>`),e.karttalinkki&&(t+=`<a href="${e.karttalinkki}" target="_blank" class="btn-primary" style="background: #28a745;">üìç Kartta</a>`),document.getElementById("spotlight-actions").innerHTML=t,renderMedia(0),renderSliderNav(),preloadCompanyMedia(e)}function preloadCompanyMedia(e){!e.media||e.media.length<=1||(console.log("Aloitetaan median esilataus yritykselle:",e.nimi),e.media.forEach((e,t)=>{if(0!==t&&"image"===e.type){const t=new Image;t.src=e.url,t.onload=()=>console.log("Esiladattu kuva:",e.url),t.onerror=()=>console.warn("Esilataus ep√§onnistui:",e.url)}}))}function renderMedia(e){const t=document.getElementById("spotlight-media"),n=currentCompany.media||[];if(console.log("Piirret√§√§n media indeksiin:",e,"Medialistasta:",n),0===n.length)return void(t.innerHTML='<div class="placeholder-media">Ei mediaa saatavilla</div>');const a=n[e];if("video"===a.type)t.innerHTML=`<iframe src="${a.url}" allowfullscreen></iframe>`;else{t.innerHTML='<div class="placeholder-media">Ladataan kuvaa...</div>';const e=new Image;console.log("Ladataan kuvaa osoitteesta:",a.url);const n=setTimeout(()=>{e.complete&&0!==e.naturalWidth||(console.warn("Kuvan lataus aikakatkaistiin (45s):",a.url),e.src="",t.innerHTML='<div class="placeholder-media">Kuvan lataus kest√§√§ liian kauan tiedoston koosta tai palvelimesta johtuen<br><small style="font-size:0.75em; opacity: 0.7;">Varmista tieoston oikeudet Drivessa.</small></div>')},45e3);e.onload=()=>{clearTimeout(n),console.log("Kuva ladattu onnistuneesti:",a.url,"Koko:",e.width,"x",e.height),t.innerHTML="",t.appendChild(e)},e.onerror=()=>{clearTimeout(n),console.error("Kuvan lataus ep√§onnistui:",a.url),console.warn("Varmista, ett√§ PHP-v√§lityspalvelin (get_image.php) toimii ja Drive-tiedosto on julkinen."),t.innerHTML=`<div class="placeholder-media">Kuvaa ei voitu ladata<br><small style="font-size:0.7em">${a.url}</small></div>`},e.alt=currentCompany.nimi,"welcome"===currentCompany.id&&(e.style.objectFit="contain",e.style.backgroundColor="white",e.style.padding="20px",e.style.width="100%",e.style.height="100%"),e.src=a.url}}function renderSliderNav(){const e=document.getElementById("slider-nav"),t=currentCompany.media||[];e.innerHTML="",t.length<=1||t.forEach((t,n)=>{const a=document.createElement("div");a.className="slider-dot "+(n===currentMediaIndex?"active":""),a.onclick=()=>{currentMediaIndex=n,renderMedia(n),updateSliderDots()},e.appendChild(a)})}function updateSliderDots(){document.querySelectorAll(".slider-dot").forEach((e,t)=>{e.classList.toggle("active",t===currentMediaIndex)})}const installBtn=document.getElementById("pwa-install-btn");window.addEventListener("beforeinstallprompt",e=>{e.preventDefault(),deferredPrompt=e,installBtn&&(installBtn.style.display="inline-block")}),installBtn&&installBtn.addEventListener("click",async()=>{if(deferredPrompt){deferredPrompt.prompt();const{outcome:e}=await deferredPrompt.userChoice;console.log(`K√§ytt√§j√§ valitsi: ${e}`),deferredPrompt=null,installBtn.style.display="none"}});